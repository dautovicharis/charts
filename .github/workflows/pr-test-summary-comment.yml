name: PR Test Summary Comment

on:
  workflow_run:
    workflows: ["Test"]
    types: [completed]

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  comment:
    name: Comment test summary on PR
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.event == 'pull_request' }}
    steps:
      - name: Download summary artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: ci-test-summary
          path: ./ci-summary
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create or update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const marker = '<!-- ci-test-summary -->';
            const pulls = context.payload.workflow_run.pull_requests || [];

            if (pulls.length === 0) {
              core.info('No pull request associated with this workflow run.');
              return;
            }

            const summaryPath = 'ci-summary/ci-test-summary.md';
            if (!fs.existsSync(summaryPath)) {
              core.info(`Summary artifact file not found at ${summaryPath}.`);
              return;
            }
            const summaryMarkdown = fs.readFileSync(summaryPath, 'utf8').trim();
            const body = `${marker}\n${summaryMarkdown}`;

            const issue_number = pulls[0].number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find(
              (comment) =>
                comment.user &&
                comment.user.type === 'Bot' &&
                typeof comment.body === 'string' &&
                comment.body.includes(marker),
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
