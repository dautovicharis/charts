name: Publish Docs Static

on:
  workflow_dispatch:
    inputs:
      playground_bundle:
        description: "Playground bundle mode"
        required: true
        default: dev
        type: choice
        options:
          - dev
          - prod
  push:
    branches:
      - main

permissions:
  contents: write

concurrency:
  group: docs-static-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-docs-static:
    name: Build and Publish docs/static
    runs-on: ubuntu-latest
    if: ${{ github.repository_owner == 'dautovicharis' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'
          cache: gradle

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Read charts version from Config.kt
        id: version
        shell: bash
        run: |
          set -euo pipefail
          config_file="buildSrc/src/main/kotlin/io/github/dautovicharis/charts/Config.kt"
          if [[ ! -f "$config_file" ]]; then
            echo "Config file not found: $config_file" >&2
            exit 1
          fi
          charts_version=$(grep -E 'const val chartsVersion\s*=\s*"' "$config_file" | sed -E 's/.*"([^"]+)".*/\1/' | tr -d '\r' | xargs)
          if [[ -z "${charts_version:-}" ]]; then
            echo "Failed to parse chartsVersion from $config_file" >&2
            exit 1
          fi
          echo "charts_version=${charts_version}" >> "$GITHUB_OUTPUT"
          echo "Config chartsVersion: ${charts_version}"

      - name: Fetch existing docs/static from docs-static branch
        run: bash scripts/fetch-docs-static.sh

      - name: Snapshot existing non-snapshot version folders
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/docs-static-state"
          for base in docs/static/api docs/static/demo docs/static/playground; do
            if [[ -d "$base" ]]; then
              find "$base" -mindepth 1 -maxdepth 1 -type d \
                -exec basename {} \; \
                | grep -Ev '^snapshot$' \
                | sort -u > "$RUNNER_TEMP/docs-static-state/$(basename "$base").before" || true
            else
              : > "$RUNNER_TEMP/docs-static-state/$(basename "$base").before"
            fi
          done

      - name: Build docs static assets
        shell: bash
        run: |
          set -euo pipefail

          playground_task="playground"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.playground_bundle }}" == "prod" ]]; then
            playground_task=":playground:jsBrowserDistribution"
          fi

          echo "Using playground task: ${playground_task}"
          ./gradlew generateDocs "${playground_task}" --no-daemon

      - name: Validate required docs static files
        shell: bash
        run: |
          set -euo pipefail
          required_files=(
            "docs/static/demo/snapshot/index.html"
            "docs/static/playground/snapshot/index.html"
          )
          for file in "${required_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "Missing required file: $file" >&2
              exit 1
            fi
          done

      - name: Validate docs release links against built static assets
        shell: bash
        run: bash scripts/test-docs-release-assets.sh

      - name: Guard against accidental deletion of historical docs versions
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/docs-static-state"
          removed=()

          for base in docs/static/api docs/static/demo docs/static/playground; do
            before_file="$RUNNER_TEMP/docs-static-state/$(basename "$base").before"
            current_file="$RUNNER_TEMP/docs-static-state/$(basename "$base").after"

            if [[ -d "$base" ]]; then
              find "$base" -mindepth 1 -maxdepth 1 -type d \
                -exec basename {} \; \
                | grep -Ev '^snapshot$' \
                | sort -u > "$current_file" || true
            else
              : > "$current_file"
            fi

            while IFS= read -r version; do
              [[ -z "$version" ]] && continue
              if ! grep -Fxq "$version" "$current_file"; then
                removed+=("${base#docs/static/}/$version")
              fi
            done < "$before_file"
          done

          if (( ${#removed[@]} > 0 )); then
            echo "Refusing to publish: historical docs directories would be deleted:"
            for item in "${removed[@]}"; do
              echo " - docs/static/$item"
            done
            echo "Historical docs versions must never be removed by this workflow."
            exit 1
          fi

      - name: Publish docs/static to docs-static branch
        env:
          REMOTE: origin
          BRANCH: docs-static
          CURRENT_VERSION: ${{ steps.version.outputs.charts_version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          bash scripts/publish-docs-static.sh

      - name: Trigger Vercel deploy hook
        env:
          VERCEL_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${VERCEL_DEPLOY_HOOK_URL:-}" ]]; then
            echo "Missing required secret: VERCEL_DEPLOY_HOOK_URL" >&2
            echo "Disable Vercel automatic Git deploys and configure a deploy hook secret in GitHub Actions." >&2
            exit 1
          fi
          echo "Triggering Vercel deployment..."
          curl -fsS -X POST "${VERCEL_DEPLOY_HOOK_URL}" >/tmp/vercel-deploy-hook-response.json
          sed -n '1,20p' /tmp/vercel-deploy-hook-response.json || true
